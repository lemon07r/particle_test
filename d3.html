<!DOCTYPE html>
<html>

<head>
<style type="text/css">
    #fps {
        float: left;
    }
    canvas {
        border: 1px solid black;
        margin: auto;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
    }
</style>

<script type="text/javascript" src="dat.gui.min.js"></script>
<script type="text/javascript" src="d3.v3.min.js"></script>
<script type="text/javascript" src="fpsmeter.min.js"></script>

<script type="text/javascript">

    var CANVAS_WIDTH = 500;
    var CANVAS_HEIGHT = 500;
    var PARTICLE_SPEED = 200;
    var TOTAL_PARTICLES = 1000;

    var fps;
    var image;
    var imageSrc = 'media/particle.png';
    var lastElapsed = 0;
    var map = {};

    window.onload = init;

    function Particle (image, x, y, width, height) {
        this.image = image;
        this.pos = {
            x: x,
            y: y
        };
        this.vel = {
            x: Math.random() * PARTICLE_SPEED - PARTICLE_SPEED / 2,
            y: Math.random() * PARTICLE_SPEED - PARTICLE_SPEED / 2
        };
        this.height = height;
        this.width = width;
    }

    function init () {
        image = new Image();
        image.onload = main;
        image.src = imageSrc;

        fps = new FPSMeter(document.body, { theme: 'dark', heat: 1, graph: 1 });

        var gui = new dat.GUI();
        gui.add(window, 'TOTAL_PARTICLES', 0, 20000);
    }

    function main () {
        var scale = fillBrowser(CANVAS_WIDTH, CANVAS_HEIGHT);

        map.canvas = d3.select(document.body)
            .append('canvas')
            .attr('width', CANVAS_WIDTH)
            .attr('height', CANVAS_HEIGHT)
            .style('width', scale.width + 'px')
            .style('height', scale.height + 'px')
            .node().getContext('2d');

        map.particles = [];

        d3.timer(function(elapsed) {
            var tick = (elapsed - lastElapsed) / 1000;
            lastElapsed = elapsed;

            clear(map.canvas);

            if (map.particles.length !== ~~TOTAL_PARTICLES) {
                spawnParticles(~~TOTAL_PARTICLES);
            }

            map.particles.forEach(function (value, index, array) {
                update(tick, value);
                render(map.canvas, value);
            });

            fps.tick();
        });
    }

    function clear (canvas) {
        canvas.fillStyle = '#FFFFFF';
        canvas.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    }

    function fillBrowser (width, height) {
        var scaleWidth = window.innerWidth / width;
        var scaleHeight = window.innerHeight / height;

        if (scaleWidth < scaleHeight) {
            return {
                width: scaleWidth * width,
                height: scaleWidth * height
            };
        } else {
            return {
                width: scaleHeight * width,
                height: scaleHeight * height
            };
        }
    }

    function render (canvas, particle) {
        canvas.drawImage(particle.image, ~~particle.pos.x, ~~particle.pos.y);
    }

    function spawnParticles (count) {
        map.particles = d3.range(count)
            .map(function(value, index, array) {
                return new Particle(
                    image,
                    Math.random() * (CANVAS_WIDTH - image.width),
                    Math.random() * (CANVAS_HEIGHT - image.height),
                    image.width,
                    image.height
                );
            });
    }

    function update (tick, particle) {
        particle.pos.x += particle.vel.x * tick;
        particle.pos.y += particle.vel.y * tick;

        if (particle.pos.x < 0 || particle.pos.x + particle.width > CANVAS_WIDTH) {
            particle.vel.x = -particle.vel.x;
        }

        if (particle.pos.y < 0 || particle.pos.y + particle.height > CANVAS_HEIGHT) {
            particle.vel.y = -particle.vel.y;
        }
    }

</script>

</html>
